<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>
        Profile
    </title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
        let userLoginId = '[[${userLogin}]]';
        let groups = [[${chatGroups}]];
    </script>
    <script src="/static/js/app.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
        }
        .container {
            display: flex;
        }
        .sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #dbdbdb;
            padding: 20px;
            height: 100vh;
        }
        .sidebar h1 {
            font-family: 'Billabong', cursive;
            font-size: 30px;
            margin-bottom: 10px;
        }
        .sidebar img {
            width: 100px;
            margin-bottom: 20px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            margin-bottom: 20px;
            cursor: pointer;
        }
        .sidebar ul li a {
            text-decoration: none;
            color: #262626;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .sidebar ul li a i {
            margin-right: 10px;
        }
        .content {
            margin-left: 100px;
            padding: 20px;
            width: calc(100% - 100px);
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .profile-header img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-right: 20px;
        }
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        .profile-info h1 {
            margin: 0;
            font-size: 24px;
        }
        .profile-info p {
            margin: 5px 0;
            color: #8e8e8e;
        }
        .profile-info .stats {
            display: flex;
            margin-top: 10px;
        }
        .profile-info .stats div {
            margin-right: 20px;
        }
        .profile-info .stats div span {
            font-weight: 500;
        }
        .profile-info .actions {
            margin-top: 10px;
        }
        .profile-info .actions button {
            background-color: #0095f6;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .profile-info .actions button.following {
            background-color: #fff;
            color: #262626;
            border: 1px solid #dbdbdb;
        }
        .profile-info .actions button a{
            color:inherit;
            text-decoration: none;
        }
        .highlights {
            display: flex;
            margin-bottom: 20px;
        }
        .highlights .highlight {
            margin-right: 10px;
            text-align: center;
        }
        .highlights .highlight img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 1px solid #dbdbdb;
        }
        .highlights .highlight p {
            margin: 5px 0 0;
            font-size: 12px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            border-top: 1px solid #dbdbdb;
            border-bottom: 1px solid #dbdbdb;
            margin-bottom: 20px;
        }
        .tabs div {
            padding: 10px 20px;
            cursor: pointer;
        }
        .tabs div.active {
            border-top: 1px solid #262626;
            font-weight: 500;
        }
        .posts {
            display: flex;
            flex-wrap: wrap;
        }
        .posts .post {
            width: calc(33.333% - 10px);
            margin: 5px;
        }
        .posts .post img {
            width: 100%;
            height: auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            .sidebar ul li a {
                font-size: 12px;
            }
            .sidebar ul li a i {
                margin-right: 0;
            }
            .content {
                margin-left: 60px;
                width: calc(100% - 60px);
            }
            .profile-header img {
                width: 100px;
                height: 100px;
            }
            .profile-info h1 {
                font-size: 18px;
            }
            .profile-info .stats div {
                margin-right: 10px;
            }
            .highlights .highlight img {
                width: 60px;
                height: 60px;
            }
            .posts .post {
                width: calc(50% - 10px);
            }
        }
        @media (max-width: 480px) {
            .posts .post {
                width: 100%;
            }
        }
        .notification-panel-wrap {
            margin: 0 auto;
            padding: 20px;
        }
        .notification-panel .header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .notification-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .notification-item img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        .notification-item .text {
            flex-grow: 1;
        }
        .notification-item .text .title {
            font-weight: bold;
        }
        .notification-item .text .subtitle {
            color: #888;
        }
        .notification-item .icon {
            color: #0095f6;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            background-color: #efefef;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .button-group .accept {
            background-color: #0095f6;
            color: #fff;
        }
        .button-group .deny {
            background-color: #efefef;
            color: #000;
        }
        .notification-panel {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: #fff;
            box-shadow: 2px 0 5px rgb(0 0 0 / 8%);
            transition: left 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        .notification-panel.open {
            left: 0;
        }
        .open-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #0095f6;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .notification {
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 1;
            transform: translateY(0);
            z-index: 9999;
        }

        .notification.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .notification-avatar {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            overflow: hidden;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .notification-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .notification-content {
            display: flex;
            flex-direction: column;
        }

        .notification-title {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .notification p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #555;
        }
        .search-box-main{
            width: 100%;
            height: 100vh;
            background-color: white;
            max-width: 400px;
            padding: 20px;
            box-sizing: border-box;
            position: absolute;
            left: -100%;
            transition: left 0.5s ease-in-out;
        }
        .search-box-main.show {
            left: 0;
        }

        .search-box-main h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .search-box-main .search-box {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }
        .search-box-main .search-box input {
            border: none;
            background: none;
            outline: none;
            flex-grow: 1;
            font-size: 16px;
        }
        .search-box-main .search-box .clear-icon {
            font-size: 16px;
            color: #ccc;
            cursor: pointer;
        }
        .search-box-main .recent {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .search-box-main .recent-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-box-main .recent-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .search-box-main .recent-item span {
            font-size: 16px;
        }
        .search-box-main .no-recent {
            font-size: 16px;
            color: #999;
            text-align: center;
            margin-top: 50px;
        }
        .search-box-main .toggle-button {
            margin: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
        }
        .search-box-main .close-button {
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            position: absolute;
            top: 20px;
            right: 20px;
        }


        .modal-picture.modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-picture .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }

        .modal-picture .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;

        }
            .post {
                background-color: #fff;
                border: 1px solid #dbdbdb;
                margin-bottom: 20px;
                border-radius: 3px;
                height: 700px;
                width: 600px;
            }
            .post-header, .post-footer {
                display: flex;
                align-items: center;
                padding: 10px;
            }
            .post-header img, .post-footer img {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                margin-right: 10px;
            }
            .post-header span {
                font-weight: 500;
            }
            .post-image img {
                width: 100%;
                height: 75%;
            }
            .post-actions {
                display: flex;
                justify-content: space-evenly;
                padding: 10px;
                position: relative;
                align-items: center;
            }
            .post-actions i {
                font-size: 24px;
                margin-right: 10px;
                cursor: pointer;
                position: relative;
            }
            .post-actions .like-container,
            .post-actions .comment-container,
            .post-actions .share-container {
                display: flex;
                align-items: center;
                position: relative;
            }
            .post-actions .like-container .like-count,
            .post-actions .comment-container .comment-count,
            .post-actions .share-container .share-count {
                font-size: 14px;
                font-weight: bold;
                margin-left: 5px;
            }
            .post-likes {
                font-weight: 500;
                padding: 0 10px;
            }
            .post-contents {
                padding: 0 10px;
            }
            .post-contents span {
                font-weight: 500;
            }
            .post-footer input {
                flex: 1;
                padding: 10px;
                border: 1px solid #dbdbdb;
                border-radius: 20px;
                outline: none;
            }
        .main-content {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
        }
        .post-carousel {
            position: relative;
        }

        .post-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px;
        }

        .post-prev {
            left: 0;
        }

        .post-next {
            right: 0;
        }

        .post-carousel-dots {
            text-align: center;
            padding: 10px 0;
        }

        .post-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: grey;
            border-radius: 50%;
            cursor: pointer;
        }

        .post-dot.active {
            background-color: black;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h1>Media Social</h1>
        <ul>
            <li>
                <a href="/">
                    <i class="fas fa-home">
                    </i>
                    Home
                </a>
            </li>
            <li>
                <a onclick="toggleContainer()">
                    <i class="fas fa-search">
                    </i>
                    Search
                </a>
            </li>
            <li>
                <a href="/chat">
                    <i class="fas fa-envelope">
                    </i>
                    Messages
                </a>
            </li>
            <li>
                <a style="cursor: pointer" onclick="toggleNotifications()">
                    <i class="fas fa-heart">
                    </i>
                    Notifications
                </a>
            </li>
            <li>
                <a th:href="@{/user/{userLogin}(userLogin=${userLogin})}">
                    <i class="fas fa-user"></i>
                    Profile
                </a>
            </li>
        </ul>
    </div>
    <div class="search-box-main" id="search-box-main">
        <span class="close-button" onclick="toggleContainer()">&times;</span>
        <h1>Search</h1>
        <div class="search-box">
            <input type="text" oninput="debounceSearchAllUser(event)" placeholder="Search">
            <span class="clear-icon">&times;</span>
        </div>
        <div class="recent">Recent</div>
        <div class="recent-item-render">
        </div>
    </div>
    <div class="content" >
        <div class="profile-header" id="user-info-content">
            <img alt="Profile picture" onclick="openModalImage()" style="cursor: pointer" id="profilePic" height="150" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&s=200" width="150"/>
            <div class="profile-info">
                <h1 th:text="${user.getFullName()}"></h1>
                <div class="stats">
                    <div>
                    <span>
                     18
                    </span>
                        posts
                    </div>
                    <div>
                        <span th:text="${user.getNumberOfFriends()}"></span>
                        Friends
                    </div>
                </div>
                <div class="actions" th:if="${userId != userLogin}">

                    <button class="following" th:if="${(statusFriend == null || statusFriend == '') && (existStatus == null || existStatus == '')}" onclick="sendAddFriend()">Add Friend</button>
                    <button class="following" th:if="${existStatus == 'pending'}">Pending</button>
                    <button class="following" th:if="${statusFriend == 'accepted'}">Friend</button>
                    <button class="following" th:if="${statusFriend == 'accepted'}" onclick="sendUnFriend()">Unfriend</button>
                    <div th:if="${statusFriend == 'pending'}">
                        <button class="following"  onclick="sendAcceptFriend()">Accpet</button>
                        <button class="following"  onclick="sendCancelFriend()">Deny</button>
                    </div>


                    <button th:if="${areFriends}">
                        <a href="/chat">
                            Message
                        </a>
                    </button>
                </div>
            </div>
        </div>
        <div class="tabs">
            <div class="active">
                POSTS
            </div>
        </div>
        <div class="main-content" id="post-container">
            <!-- Posts will be appended here -->
        </div>
    </div>
    <div class="notification-panel" id="notificationPanel">
        <button class="close-button" onclick="toggleNotifications()">
            &times;
        </button>
        <div class="notification-panel-wrap">
            <div class="header">
                Notifications
            </div>
            <div id="notification-item-render">
                <div class="notification-item" th:each="notify : ${notifications}">
                    <img alt="Profile picture" height="40" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&s=200" width="40"/>
                    <div class="text">
                        <div class="title" th:text="${notify.getContent()}"></div>
                        <div class="subtitle" th:text="${notify.getCreatedAt()}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="notification-container" class="notification hidden">
    <div class="notification-avatar">
        <img id="notification-avatar" src="" alt="Avatar">
    </div>
    <div class="notification-content">
        <h4 class="notification-title">Thông báo</h4>
        <p id="notification-message">Bạn có tin nhắn mới</p>
    </div>
</div>


<!-- Popup Modal -->
<div id="uploadModal" class="modal-picture modal">
    <div class="modal-content">
        <span class="close" onclick="closeModelImage()">&times;</span>
        <h2>Upload Profile Picture</h2>
        <form id="uploadForm" method="post"  enctype="multipart/form-data" action="/user/upload">
            <input type="file" name="file" accept="image/*" id="file" required />
            <button type="submit" id="uploadBtn">Upload</button>
        </form>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    let loginUserId = /*[[${userLogin}]]*/ 'defaultUser';
    let userIdCurrent = '[[${userId}]]';
    let userName =  /*[[${userName}]]*/ 'defaultUser';
    let stompClient;
    let timeOutThird;
    let isLoading = false;
    let noMorePosts = false;
    let page = 0;
    const size = 10;
    let totalPostsLoaded = 0;

    // Get elements
    const modal = document.getElementById("uploadModal");
    const profilePic = document.getElementById("profilePic");
    const closeBtn = document.querySelector(".close");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");

    // Show modal on click
    function openModalImage(){
        modal.style.display = "block";
    }

    function closeModelImage(){
        modal.style.display = "none";

    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    $(document).ready(function() {
        connectToWebSocket();
        renderStatusFriend();
        loadUserPosts(userIdCurrent);
    });
    function connectToWebSocket() {
        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {

            stompClient.subscribe('/user/queue/notifications', function (message) {
                const chatMessage = JSON.parse(message.body);
                if(chatMessage.type === 'ADD_FRIEND' || chatMessage.type === 'ACCEPT_FRIEND'){
                    showNotification('https://via.placeholder.com/50', chatMessage.content);
                }
                renderNotify();
                renderStatusFriend();
            });
        });
    }

    function sendAddFriend(){
        const type = "ADD_FRIEND";
        const senderId = userIdCurrent;
        const content = "";
        const message = { senderId , content , fullName: userName, type , attr1: loginUserId};
        stompClient.send("/app/send-to-user/" + userName, {}, JSON.stringify(message));
        renderCurrentStatusFriend(message.type);
    }

    function sendCancelFriend(){
        //Hủy kết bạn
        const type = "CANCEL_FRIEND";
        const senderId = userIdCurrent;
        const content = "";
        const message = { senderId , content , fullName: userName, type , attr1: loginUserId};
        stompClient.send("/app/send-to-user/" + userName, {}, JSON.stringify(message));
        renderCurrentStatusFriend(message.type);
    }

    function sendAcceptFriend(){
        const type = "ACCEPT_FRIEND";
        const senderId = userIdCurrent;
        const content = "";
        const message = { senderId , content , fullName: userName, type , attr1: loginUserId};
        stompClient.send("/app/send-to-user/" + userName, {}, JSON.stringify(message));
        renderCurrentStatusFriend(message.type);
    }

    function sendUnFriend(){
        const type = "UNFRIEND";
        const senderId = userIdCurrent;
        const content = "";
        const message = { senderId , content , fullName: userName, type , attr1: loginUserId};
        stompClient.send("/app/send-to-user/" + userName, {}, JSON.stringify(message));
        renderCurrentStatusFriend(message.type);
    }

    function renderNotify(){
        $.ajax({
            url: '/notifications/user',
            method: 'GET',
            success: function(data) {
                let notificationPanelWrap = $('#notification-item-render');
                notificationPanelWrap.empty();
                data.forEach(function(notification) {
                    let notificationItem = `
                    <div class="notification-item">
                        <img src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&s=200" alt="Profile picture" width="40" height="40">
                        <div class="text">
                            <div class="title">${notification.content}</div>
                            <div class="subtitle">${new Date(notification.createdAt).toLocaleString()}</div>
                        </div>
                    </div>
                `;
                    notificationPanelWrap.append(notificationItem);
                });
            },
            error: function(error) {
                console.error('Error fetching notifications:', error);
            }
        });
    }

    function toggleNotifications() {
        let panel = document.getElementById('notificationPanel');
        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
        } else {
            panel.classList.add('open');
            renderNotify();
        }
    }

    function renderCurrentStatusFriend(type) {
        let renderViewStatus = $('.profile-info .actions');
        let htmlRender = "";
        switch (type) {
            case "ADD_FRIEND":
                htmlRender = `<button class="following">Pending</button>`
                break;
            case "ACCEPT_FRIEND":
                htmlRender = `<button class="following" onClick="sendUnFriend()">Unfriend</button>
                                <button>
                                    <a href="/chat">
                                        Message
                                    </a>
                                </button>`
                break;
            case "UNFRIEND":
                htmlRender = `
                 <button class="following" onClick="sendAddFriend()">Add Friend</button>
                `
                break;
            case "CANCEL_FRIEND":
                htmlRender = `
                <button class="following" onClick="sendAddFriend()">Add Friend</button>`
                break;
            default:
                break;
        }
        renderViewStatus.html(htmlRender);
    }

    function renderStatusFriend() {
        $.ajax({
            url: '/user/PartialUserProfileStatus',
            type: 'GET',
            data: {userId: userIdCurrent},
            success: function (response) {
                $('#user-info-content').html(response);
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', error);
                alert('Không thể tải thông tin.');
            }
        });
    }

    function showNotification(avatarUrl, message) {
        const notification = document.getElementById('notification-container');
        const notificationAvatar = document.getElementById('notification-avatar');
        const notificationMessage = document.getElementById('notification-message');

        // Set avatar and message
        notificationAvatar.src = avatarUrl;
        notificationMessage.textContent = message;

        // Show notification
        notification.classList.remove('hidden');

        // Hide notification after 3 seconds
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }

    function markAsRead(){
        $.ajax({
            url: '/notifications/mark-as-read',
            method: 'POST',
            success: function() {
                renderNotify();
            },
            error: function(error) {
                console.error('Error marking notifications as read:', error);
            }
        });
        renderNotify();
    }

    function toggleContainer() {
        let container = document.getElementById('search-box-main');
        container.classList.toggle('show');
    }

    const debounceSearchAllUser = debounceAll((event) => {
        const input = event.target.value;
        fetchAllUsersWithAjax(input);
    }, 1000);

    function debounceAll(func, delay) {
        return function (...args) {
            clearTimeout(timeOutThird);
            timeOutThird = setTimeout(() => func.apply(this, args), delay);
        };
    }
    function fetchAllUsersWithAjax(name) {
        $.ajax({
            url: '/user/search',
            type: 'GET',
            data: { name: name},
            success: function(response) {
                let recentItemsHtml = response.map(user => `
                        <a style="text-decoration: none; color:black; " href="/user/${user.userId}">
                            <div class="recent-item">
                                <img alt="User profile picture" height="40" src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&s=200" width="40"/>
                                <span>${user.fullName}</span>
                            </div>
                        </a>
                    `).join('');
                $('.recent-item-render').html(recentItemsHtml);
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', error);
                alert('Không thể tải bạn bè.');
            }
        });
    }

    function loadUserPosts(userId) {
        if (isLoading || noMorePosts) return; // Prevent duplicate loading
        isLoading = true;
        $('#loading').show();

        $.ajax({
            url: `/api/posts/user-posts`,
            type: 'GET',
            data: { userId: userId, page: page, size: size },
            success: function(posts) {
                stompClient.connect({}, () => {
                    console.log("Connected to WebSocket");
                    posts.forEach(function(post) {
                            stompClient.subscribe('/topic/update-reaction/' + post.postId, (message) => {
                                const reactionUpdate = JSON.parse(message.body);
                                const postElement = $(`.post[data-post-id="${reactionUpdate.postId}"]`);
                                const reactionIcon = reactionUpdate.isLiked
                                    ? `<div id="reaction-icon" class="reaction-icon">
                                            <i class="fas fa-heart" style="color: red;"></i>
                                       </div>`
                                    : `<div id="reaction-icon" class="reaction-icon">
                                        <i class="far fa-heart"></i>
                                       </div>`;

                                postElement.find('.reaction-icon').replaceWith(reactionIcon);
                                postElement.find('.like-count').text(reactionUpdate.reactionCount);
                            });
                    })
                });

                const postContainer = $('#post-container');

                if (posts.length === 0) {
                    noMorePosts = true;
                    postContainer.append('<div class="no-more-posts">No more posts to see here</div>');
                } else {
                    posts.forEach(post => {
                        let postElement;
                        const formattedDate = new Date(post.createdAt).toLocaleString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                        });

                        const reactionIcon = post.isLiked
                            ? `<div id="reaction-icon" class="reaction-icon">
                               <i class="fas fa-heart" style="color: red;"></i>
                           </div>`
                            : `<div id="reaction-icon" class="reaction-icon">
                               <i class="far fa-heart"></i>
                           </div>`;

                        if (post.imagesData.length === 0) {
                            // Case: No images
                            postElement = $(
                                `<div class="post" data-post-id="${post.postId}">
                                <div class="post-header">
                                    <img alt="Profile picture" height="32" src="${post.avatarUrlPoster}" width="32"/>
                                    <span>${post.fullNamePoster}</span>
                                </div>
                                <div class="post-create-dt" style="font-weight: 300; color: grey; padding: 0 10px;">
                                    ${formattedDate}
                                </div>
                                <div class="post-contents">
                                    ${post.content}
                                </div>
                                <div class="post-actions">
                                    <div class="like-container">
                                        ${reactionIcon}
                                        <span class="like-count">${post.reactionCount}</span>
                                    </div>
                                </div>
                            </div>`
                            );
                        } else {
                            // Case: With images (carousel)
                            const images = post.imagesData.map(
                                (image, index) => `<img src="data:image/png;base64,${image}" style="display: ${index === 0 ? 'block' : 'none'};" />`
                            ).join('');

                            const dots = post.imagesData.length > 1
                                ? `<div class="post-carousel-dots">
                                   ${post.imagesData.map((_, index) => `<div class="post-dot ${index === 0 ? 'active' : ''}" onclick="goToPostImage(this, ${index})"></div>`).join('')}
                               </div>`
                                : '';

                            const navButtons = post.imagesData.length > 1
                                ? `<button class="post-nav-button post-prev" onclick="prevPostImage(this)">&#8249;</button>
                               <button class="post-nav-button post-next" onclick="nextPostImage(this)">&#8250;</button>`
                                : '';

                            postElement = $(
                                `<div class="post" data-post-id="${post.postId}">
                                <div class="post-header">
                                    <img alt="Profile picture" height="32" src="${post.avatarUrl}" width="32"/>
                                    <span>${post.fullNamePoster}</span>
                                </div>
                                <div class="post-image">
                                    <div class="post-carousel">
                                        ${images}
                                        ${navButtons}
                                        ${dots}
                                    </div>
                                </div>
                                <div class="post-actions">
                                    <div class="like-container">
                                        ${reactionIcon}
                                        <span class="like-count">${post.reactionCount}</span>
                                    </div>
                                </div>
                                <div class="post-create-dt" style="font-weight: 300; color: grey; padding: 0 10px;">
                                    ${formattedDate}
                                </div>
                                <div class="post-contents">
                                    <span>${post.fullNamePoster}</span> ${post.content}
                                </div>
                            </div>`
                            );
                        }

                        postContainer.append(postElement);
                    });

                    totalPostsLoaded += posts.length;
                    page++;
                }

                isLoading = false;
                $('#loading').hide();
            },
            error: function(error) {
                console.error('Error loading posts:', error);
                isLoading = false;
                $('#loading').hide();
            }
        });
    }

    $(document).ready(function() {
        const userId = /*[[${userId}]]*/ 'defaultUser';
        loadUserPosts(userId);
    });

    $(document).on('click', '.reaction-icon', function() {
        const postElement = $(this).closest('.post');
        const postId = postElement.data('post-id');
        const isLiked = $(this).find('i').hasClass('fas');
        const userId = userLoginId;

        const reaction = { postId, userId, isLiked: isLiked };

        // Send WebSocket message to update reaction in real-time
        stompClient.send(`/app/update-reaction/${postId}`, {}, JSON.stringify(reaction));

        // Update the UI immediately for better user experience
        const reactionIcon = !isLiked
            ? `<div id="reaction-icon" class="reaction-icon">
               <i class="fas fa-heart" style="color: red;"></i>
           </div>`
            : `<div id="reaction-icon" class="reaction-icon">
               <i class="far fa-heart"></i>
           </div>`;

        postElement.find('.reaction-icon').replaceWith(reactionIcon);
        const likeCountElement = postElement.find('.like-count');
        likeCountElement.text(parseInt(likeCountElement.text()) + (isLiked ? -1 : 1));
    });

    function handleCommentKeyPress(event, postId) {
        if (event.key === "Enter") {
            sendComment(postId);
        }
    }

    function sendComment(postId) {
        const inputElement = document.getElementById(`comment-input-${postId}`);
        const content = inputElement.value.trim();
        const userId = userLoginId;
        if (content === "") return;

        const comment = { postId, userId, content, parentCommentId: null };

        stompClient.send(`/app/send-comment/${postId}`, {}, JSON.stringify(comment));
        inputElement.value = "";

        const commentCountElement = document.querySelector(`.post[data-post-id="${postId}"] .comment-count`);
        commentCountElement.textContent = parseInt(commentCountElement.textContent) + 1;

        alert("Your comment has been posted");
    }

    function displayComment(comment) {
        const commentElement = document.createElement("div");
        commentElement.classList.add("comment");
        commentElement.innerHTML = `
        <img alt="User profile picture" height="32" src="${comment.avatarUrl}" width="32"/>
        <div class="comment-content">
            <span>${comment.fullName}</span> ${comment.content}
        </div>
    `;
        const postElement = document.querySelector(`.post[data-post-id="${comment.postId}"] .comments`);
        postElement.appendChild(commentElement);
    }

    $(document).on('click', '.comment-container', function() {
        const postId = $(this).closest('.post').data('post-id');
        const postAuthorName = $(this).closest('.post').find('.post-header span').text();
        currentPostId = postId;

        $('#post-author-name').text(postAuthorName);
        $('.comment-popup-container').show();

        $.ajax({
            url: `/api/comments/${postId}`,
            type: 'GET',
            success: function(comments) {
                displayCommentsPosts(comments);
                openCommentPopup(postId, postAuthorName);
            },
            error: function(error) {
                console.error('Error loading comments:', error);
            }
        });
    });
    function goToPostImage(dot, index) {
        const postElement = $(dot).closest('.post');
        const images = postElement.find('.post-carousel img');
        images.hide();
        images.eq(index).show();

        const dots = postElement.find('.post-dot');
        dots.removeClass('active');
        dots.eq(index).addClass('active');
    }

    function prevPostImage(button) {
        const postElement = $(button).closest('.post');
        const images = postElement.find('.post-carousel img');
        const activeIndex = images.index(images.filter(':visible'));
        const newIndex = (activeIndex - 1 + images.length) % images.length;
        goToPostImage(postElement.find('.post-dot').eq(newIndex), newIndex);
    }

    function nextPostImage(button) {
        const postElement = $(button).closest('.post');
        const images = postElement.find('.post-carousel img');
        const activeIndex = images.index(images.filter(':visible'));
        const newIndex = (activeIndex + 1) % images.length;
        goToPostImage(postElement.find('.post-dot').eq(newIndex), newIndex);
    }
</script>
</body>
</html>
